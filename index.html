<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Journaly</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=mail" />

</head>
<body>

    <div class="login-box" id="login-box">
        <form id="loginForm">
            <div class="login-header">
                <h2>Sign In</h2>
            </div>
            
            <div class="input-box">
                <span class="icon"></span>
                <input type="email" id="email" required>
                <label>Email</label>
            </div>
            
            <div class="input-box">
                <span class="icon"></span>
                <input type="password" id="password" required>
                <label>Password</label>
            </div>
            
            <div class="remember-forgot">
                <label><input type="checkbox">Remember me</label>
                <a href="./passwordreset.html">Forgot Password?</a>
            </div>
            
            <button type="submit" id="signInBtn">Sign In</button>
            <button type="button" id="googleSignInBtn">Sign In with Google</button>
            
            <div class="register-link">
                <p>Don't have an account? <a href="./register.html">Register</a></p>
            </div>
            
            <div id="errorMessage" style="color: red; margin-top: 10px; display: none;"></div>
            <div id="debugInfo" style="color: yellow; margin-top: 10px; font-size: 12px;"></div>
        </form>
    </div>

    <script type="module">
        // DIAGNOSTIC SCRIPT - Check what's happening
        console.log("========================================");
        console.log("ðŸ” DIAGNOSTIC MODE");
        console.log("========================================");
        console.log("Document ready state:", document.readyState);
        console.log("Current URL:", window.location.href);
        
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAWmlQgPu34uIDOsBBy4J3bdPB4QFue1iI",
            authDomain: "journal-d2fcd.firebaseapp.com",
            projectId: "journal-d2fcd",
            storageBucket: "journal-d2fcd.firebasestorage.app",
            messagingSenderId: "279588365736",
            appId: "1:279588365736:web:47c252930b9fad19fd299d",
            measurementId: "G-6QHND3BWFR"
        };

        console.log("ðŸ”¥ Initializing Firebase...");
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        console.log("âœ… Firebase initialized!");

       

        // Initialize after a short delay to ensure DOM is ready
        function init() {
            console.log("ðŸŽ¯ Running initialization...");
            
            const elements = checkElements();

            // Check if all required elements exist
            if (!elements.loginForm || !elements.email || !elements.password || 
                !elements.errorMessage || !elements.googleSignInBtn) {
                console.error("âŒ CRITICAL: Some elements are missing!");
                alert("ERROR: Page elements not found. Check console for details.");
                return;
            }

            console.log("âœ… All elements found! Setting up event listeners...");

            // Helper functions
            function showError(message) {
                console.error("âŒ Error:", message);
                elements.errorMessage.textContent = message;
                elements.errorMessage.style.display = 'block';
            }

            function hideError() {
                elements.errorMessage.style.display = 'none';
            }

            // Email/Password Login
            elements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log("ðŸ“ Login form submitted");
                hideError();

                const email = elements.email.value.trim();
                const password = elements.password.value;

                console.log("ðŸ“§ Email:", email);
                console.log("ðŸ”‘ Password length:", password.length);

                if (!email || !password) {
                    showError('Please enter both email and password');
                    return;
                }

                try {
                    console.log("ðŸ” Attempting login...");
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    console.log("âœ… Login successful!", userCredential.user.email);
                    console.log("User ID:", userCredential.user.uid);
                    alert('Login successful! Redirecting...');
                    window.location.href = './welcome.html';
                } catch (error) {
                    console.error("âŒ Login failed:");
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    
                    let errorMessage = '';
                    switch (error.code) {
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email format';
                            break;
                        case 'auth/user-not-found':
                            errorMessage = 'No account found with this email';
                            break;
                        case 'auth/wrong-password':
                            errorMessage = 'Incorrect password';
                            break;
                        case 'auth/invalid-credential':
                            errorMessage = 'Invalid email or password';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = 'Too many failed attempts. Please try again later';
                            break;
                        default:
                            errorMessage = `Login failed: ${error.message}`;
                    }
                    showError(errorMessage);
                    alert(errorMessage);
                }
            });

            // Google Sign-In
            elements.googleSignInBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log("ðŸ”µ Google sign-in button clicked");
                hideError();

                try {
                    console.log("ðŸ” Creating Google provider...");
                    const provider = new GoogleAuthProvider();
                    
                    console.log("ðŸ” Opening popup...");
                    const result = await signInWithPopup(auth, provider);
                    
                    console.log("âœ… Google sign-in successful!");
                    console.log("User:", result.user.email);
                    alert('Google sign-in successful!');
                    window.location.href = './welcome.html';
                } catch (error) {
                    console.error("âŒ Google sign-in failed:");
                    console.error("Error code:", error.code);
                    console.error("Error message:", error.message);
                    
                    let errorMessage = '';
                    switch (error.code) {
                        case 'auth/popup-closed-by-user':
                            errorMessage = 'Sign-in cancelled';
                            break;
                        case 'auth/popup-blocked':
                            errorMessage = 'Please allow popups for this site';
                            break;
                        case 'auth/unauthorized-domain':
                            errorMessage = 'Domain not authorized in Firebase Console';
                            break;
                        default:
                            errorMessage = `Google sign-in failed: ${error.message}`;
                    }
                    showError(errorMessage);
                    alert(errorMessage);
                }
            });

            console.log("âœ… Event listeners attached successfully!");
            console.log("========================================");
        }

        // Multiple ways to ensure DOM is ready
        if (document.readyState === 'loading') {
            console.log("â³ DOM still loading, waiting...");
            document.addEventListener('DOMContentLoaded', () => {
                console.log("âœ… DOMContentLoaded fired");
                setTimeout(init, 100); // Small delay to be sure
            });
        } else {
            console.log("âœ… DOM already ready");
            setTimeout(init, 100); // Small delay to be sure
        }

        // Backup: Also try after window load
        window.addEventListener('load', () => {
            console.log("âœ… Window load event fired");
        });
    </script>

    
</body>
</html>